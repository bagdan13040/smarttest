# Диагностика проблем с генерацией на Android

## Основные причины оффлайн режима на Android/эмуляторе:

### 1. **API ключ не передается**
- ✅ **Решение**: Убедитесь, что API ключ сохранен в настройках приложения
- На Android .env файл может не загружаться корректно
- API ключ должен быть введен через интерфейс настроек в приложении

### 2. **SSL сертификаты**
- ❗ На Android могут быть проблемы с верификацией SSL сертификатов
- ✅ **Решение**: Код теперь автоматически повторяет запрос без проверки SSL при ошибке

### 3. **Сетевые разрешения**
- ✅ Убедитесь, что в buildozer.spec указаны разрешения:
```
android.permissions = INTERNET,ACCESS_NETWORK_STATE
```

### 4. **Библиотека requests на Android**
- Библиотека `requests` требует дополнительные зависимости на Android
- ✅ Убедитесь, что в buildozer.spec указаны все зависимости:
```
requirements = python3,kivy,requests,python-dotenv,urllib3,charset_normalizer,idna,certifi
```

## Проверка через logcat (Android Debug Bridge)

Подключите устройство и запустите:
```bash
adb logcat | grep -i "python\|llm"
```

Вы должны увидеть логи, начинающиеся с `[LLM]`:
- `[LLM] Platform: linux` (на Android показывает linux)
- `[LLM] API Key found: ...` или `[LLM] Error: OPENROUTER_API_KEY not found`
- `[LLM] Sending request to ...`
- `[LLM] Response status: 200` (успех) или сообщения об ошибках

## Типичные ошибки и решения:

### Ошибка: "OPENROUTER_API_KEY not found"
**Причина**: API ключ не найден  
**Решение**: 
1. Откройте настройки в приложении
2. Введите ваш API ключ OpenRouter
3. Сохраните настройки
4. Попробуйте генерацию снова

### Ошибка: "SSLError" или "certificate verify failed"
**Причина**: Проблемы с SSL сертификатами  
**Решение**: Код автоматически повторяет запрос без проверки SSL

### Ошибка: "ConnectionError" или "Network is unreachable"
**Причина**: Нет интернет-соединения или заблокирован доступ  
**Решение**:
1. Проверьте интернет-соединение на устройстве
2. Убедитесь, что приложение имеет разрешение на доступ к сети
3. Проверьте, не блокирует ли файрвол или VPN доступ к openrouter.ai

### Ошибка: "Timeout"
**Причина**: Медленное соединение или сервер не отвечает  
**Решение**: Попробуйте еще раз при лучшем интернет-соединении

## Тестирование API ключа

Вы можете проверить API ключ вручную с помощью curl:
```bash
curl https://openrouter.ai/api/v1/chat/completions \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{"model": "xiaomi/mimo-v2-flash:free", "messages": [{"role": "user", "content": "test"}]}'
```

Если получаете ответ - ключ работает.

## Альтернативное решение: Использование прокси-сервера

Если прямой доступ к OpenRouter API не работает на Android:
1. Создайте простой прокси-сервер на своем компьютере
2. В настройках приложения укажите URL сервера
3. Сервер будет проксировать запросы к OpenRouter

## Сборка для отладки

Для получения подробных логов соберите APK с флагом отладки:
```bash
buildozer android debug
```

Затем установите и запустите, следя за логами через adb logcat.

## Проверка работы на эмуляторе

Убедитесь, что эмулятор имеет доступ к интернету:
```bash
adb shell ping -c 3 8.8.8.8
```

Если пинг не проходит - проблема в настройках эмулятора.
