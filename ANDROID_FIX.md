# Решение проблемы оффлайн режима на Android

## Основная причина проблемы

На Android приложение работает в оффлайн режиме, потому что **API ключ не передается в функцию генерации**. Это происходит из-за того, что:

1. `.env` файл может не включаться в APK или путь к нему неправильный
2. API ключ должен вводиться через настройки приложения, а не через .env файл

## Решение: Используйте настройки в приложении

### Шаг 1: Введите API ключ через приложение

1. Запустите приложение на Android/эмуляторе
2. Перейдите во вкладку **"Настройки"** (Settings)
3. В поле **"API Ключ OpenRouter"** введите ваш ключ
4. Нажмите **"Сохранить настройки"**

### Шаг 2: Проверьте сохранение

API ключ должен сохраняться в JsonStore (файл `settings.json` внутри приложения), а не в .env файле.

## Диагностика через ADB

Подключите устройство к компьютеру и выполните:

```bash
# Установите APK с test_network.py
adb push test_network.py /sdcard/

# Запустите приложение и проверьте логи
adb logcat | grep -E "LLM|python"
```

### Что искать в логах:

**Успешная работа:**
```
[LLM] API Key found: sk-or-v1...
[LLM] Sending request to https://openrouter.ai/api/v1/chat/completions...
[LLM] Response status: 200
```

**Проблема - нет API ключа:**
```
[LLM] Error: OPENROUTER_API_KEY not found in environment variables or settings
```
➡️ **Решение**: Введите ключ через настройки приложения

**Проблема - SSL:**
```
[LLM] SSLError: ...
[LLM] Retrying with verify=False...
```
➡️ Код автоматически повторяет без SSL

**Проблема - нет интернета:**
```
[LLM] ConnectionError: ...
[LLM] Check your internet connection
```
➡️ Проверьте интернет-соединение на устройстве

## Проверка buildozer.spec

Убедитесь, что в файле [buildozer.spec](buildozer.spec) указано:

```ini
# Зависимости для работы с API
requirements = python3,kivy,requests,python-dotenv,urllib3,charset_normalizer,idna,certifi

# Разрешения для интернета
android.permissions = INTERNET,ACCESS_NETWORK_STATE

# Включение .env файла (опционально, но рекомендуется)
source.include_patterns = .env
```

## Тестирование на эмуляторе

### 1. Проверьте доступ к интернету в эмуляторе:
```bash
adb shell ping -c 3 8.8.8.8
```

Если пинг не работает:
- В настройках эмулятора включите сеть
- Перезапустите эмулятор

### 2. Скопируйте тестовый файл на эмулятор:
```bash
adb push test_network.py /sdcard/Download/
```

### 3. Запустите тест через приложение или терминал

## Часто задаваемые вопросы

### Q: Почему на компьютере работает, а на телефоне нет?
**A:** На компьютере используется `.env` файл с API ключом. На Android этот файл может не загружаться. **Решение**: Введите API ключ через настройки в приложении.

### Q: Я ввел API ключ в настройки, но всё равно оффлайн режим
**A:** Проверьте:
1. Нажали ли вы "Сохранить настройки"?
2. Есть ли интернет на устройстве?
3. Проверьте логи через ADB

### Q: Ошибка "certificate verify failed"
**A:** Код автоматически повторяет запрос без проверки SSL. Если проблема остается, проверьте дату и время на устройстве.

### Q: Можно ли использовать .env файл на Android?
**A:** Технически да, но это ненадежно. Лучше использовать настройки приложения, где ключ сохраняется в JsonStore.

### Q: Где хранится API ключ на Android?
**A:** В файле `settings.json` в приватном хранилище приложения:
```
/data/data/org.example.kivyapp/files/settings.json
```

## Быстрое решение

**Самый простой способ:**

1. ✅ Убедитесь, что в [buildozer.spec](buildozer.spec) есть все зависимости и разрешения
2. ✅ Пересоберите APK: `buildozer android clean && buildozer android debug`
3. ✅ Установите APK на устройство
4. ✅ Запустите приложение
5. ✅ Перейдите в настройки
6. ✅ Введите API ключ OpenRouter
7. ✅ Сохраните
8. ✅ Попробуйте сгенерировать тест

Если после этого всё равно не работает - смотрите логи через ADB (см. выше).

## Альтернатива: Прокси-сервер

Если прямой доступ к OpenRouter API не работает на вашем устройстве, можно использовать прокси-сервер на компьютере. Инструкции в файле [server.py](server.py).

## Получение API ключа

Если у вас нет API ключа OpenRouter:
1. Зайдите на https://openrouter.ai
2. Зарегистрируйтесь
3. Перейдите в Keys: https://openrouter.ai/keys
4. Создайте новый ключ
5. Скопируйте его (начинается с `sk-or-v1-...`)
6. Введите в настройки приложения

## Контакты для поддержки

Если проблема остается:
1. Соберите логи через `adb logcat`
2. Проверьте все пункты выше
3. Опишите проблему подробно
